# Kardiaflow Infrastructure Deployment Guide

This folder contains the infrastructure-as-code (IaC) scripts for deploying and
tearing down the minimal Kardiaflow development environment in Azure using Bicep
and the Azure CLI.


## What It Deploys


| Resource Group | Resources created                                                                    | Why it exists | Cost guidance                                                                                                                                                                         |
|----------------|--------------------------------------------------------------------------------------|---------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **kardia‑rg‑dev** | • `kardia‑dbx` (Databricks workspace)<br>• `kardiaadlsdemo` (ADLS Gen2 account, `raw` container)  | Control objects defined in `deploy.bicep`. | • Workspace is control‑plane only (no cost while clusters are off).<br>• Storage: pay for data stored; Standard _LRS_ hot tier.                                                       |
| **kardia‑dbx‑managed** (autogenerated) | • `dbmanagedidentity`<br>• `dbstorage<random>`<br>• `workers‑vnet`<br>• `workers‑sg` | Automatically provisioned by Databricks for every workspace. | • Managed identity, VNet, NSG are **free**.<br>• `dbstorage…` holds DBFS root & logs; typically \<5 GB.                                                                               |
| **NetworkWatcherRG** (autogenerated) | •`NetworkWatcher_<region>`                                                           | Created by Azure the first time a VNet exists in a region. | Free                                                                                                                                                                                  |

### FinOps best practices

1. **Terminate clusters** when you finish a demo; DBU billing stops within ~5 min.  
2. In the Azure portal, set the workspace storage account’s **Replication** to **LRS** (one click) to halve its cost.  
3. Optionally add a **lifecycle rule** on `dbstorage…` and `kardiaadlsdemo` to delete logs or test data older than 
   30 days.  
4. Leave Network Watcher as‑is (free). Do **not** enable traffic analytics unless you need them.  
5. Periodically run [`az deployment group what-if`](#dry-run-deployment) to confirm no new billable resources will be added by a redeploy. "

## Deploy Instructions

Run these from your local terminal in the project root. Make sure you're logged into the correct Azure subscription.

**1. Load environment variables from .env**

```bash
source infra/.env
```

---

**2. Create the Azure resource group**

```bash
az group create --name "$RG" --location eastus
```

---

**3.  Deploy infrastructure with Bicep (Databricks + ADLS)**

```bash
az deployment group create \
  --resource-group "$RG" \
  --template-file infra/bicep/deploy.bicep \
  --name "$DEPLOY"
```

---

**4. Generate a Databricks Personal Access Token (PAT)**

(Databricks UI → Settings → Developer → Generate New Token)

---

**5. Add your PAT to.env as `DATABRICKS_PAT=...`**

---

**6. Run gen_sas.sh to auto-generate and store the ADLS SAS token in Databricks**

```bash
infra/deploy/gen_sas.sh
```

---

**7. Build and push the kflow wheel to the workspace**

This will build the wheel using pyproject.toml and upload it to /Workspace/Shared/libs/ in the Databricks Workspace.

```bash
infra/deploy/build_push_kflow.sh
```

---

**8. Attach the wheel to your Databricks cluster**

(Compute → Cluster → Libraries → Install → /Shared/libs/kflow-0.1.0-py3-none-any.whl)

---

**9. Tear down all provisioned resources safely**

```bash
./infra/deploy/teardown.sh
```

The teardown script script will:

- Delete the Databricks workspace (which deletes the managed RG too)
- Delete the main resource group (kardia-rg-dev)
- Print a confirmation message
- Resources will disappear over the next 2–5 minutes.

---

### Dry-Run Deployment

To preview what the deployment will do without actually creating resources:

```bash
az deployment group what-if \
  --resource-group "$RG" \
  --template-file infra/bicep/deploy.bicep \
  --name "$DEPLOY"
```